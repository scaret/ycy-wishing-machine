<!doctype html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta charset="utf-8">
    <link href="https://cdn.bootcss.com/twitter-bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdn.bootcss.com/twitter-bootstrap/4.3.1/js/bootstrap.min.js"></script>
    <script src="https://cdn.bootcss.com/bootbox.js/4.3.0/bootbox.min.js"></script>
    <script src="https://cdn.bootcss.com/axios/0.18.0/axios.min.js"></script>
    <script src="https://cdn.agora.io/sdk/web/AgoraRTCSDK-2.6.1.js"></script>
    <script src="../../vendor/eruda.js"></script>
</head>
<body style="margin: 0;">
<div id="video-container"></div>
<div class="input-group mb-3">
    <input id="textMessage" type="text" class="form-control" placeholder="来许愿吧！" aria-label="来许愿吧！" aria-describedby="sendMessage">
    <div class="input-group-append">
        <button class="btn btn-outline-secondary" type="button" id="sendMessage" onclick="sendTextMessage()">发射！</button>
    </div>
</div>
<br/>

<div id="accordion" style="position: fixed; bottom: 0; width: 100%;">
    <div class="card">
        <div class="card-header" id="headingOne">
            <h5 class="mb-0">
                <button class="btn btn-link" data-toggle="collapse" data-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                    开发日志
                </button>
            </h5>
        </div>

        <div id="collapseOne" class="collapse" aria-labelledby="headingOne" data-parent="#accordion">
            <div class="card-body">
                <ul class="list-group list-group-flush">
                    <li class="list-group-item">v1.0.1 2019年04月12日 用户昵称（半夜爬起来换纸）</li>
                    <li class="list-group-item">v1.0.0 2019年04月11日 咕咕鸡文字API对接完成！</li>
                    <li  class="list-group-item">v0.9.0 2019年04月10日 视频直播完成！</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
    eruda.init();
    AgoraRTC.getSupportedCodec().then(console.log);
</script>
<script>
    const elem = document.createElement('video');
    elem.muted = true;
    elem.setAttribute("muted", "muted");
    elem.setAttribute("playsinline", "playsinline");
    elem.setAttribute("style", "width: 100%");
    const container = document.getElementById("video-container");
    container.innerHTML = "";
    container.appendChild(elem);

    var cname = "ycy_wishing_machine";
    var codec = "vp8";
    AgoraRTC.getSupportedCodec().then(function(codecs){
        console.log("codecs", codecs);
        if (codecs.video.indexOf("VP8" !== -1)){
            codec = "vp8";
        }else{
            codec = "h264";
        }
        main();
    });

    function main(){
        var client = AgoraRTC.createClient({mode: "rtc", codec: "vp8"});
        client.init("b7db71a6d9724c3f940cbcddcbd2b09d", function () {
            client.join(null, cname + "_" + codec, null, function(){
                console.log("Client joined");
                client.on("stream-added", function(evt){
                    console.log("stream-added", evt);
                    if (evt.stream.getId() === 8888){
                        console.log("Subscribing stream", evt.stream.getId());
                        client.subscribe(evt.stream);
                    }
                });
                client.on("stream-subscribed", function(evt){
                    console.log("stream subscribed", evt.stream);
                    // document.getElementById("remote-container").innerHTML = "";
                    // evt.stream.play("remote-container", {muted: true, controls: true});
                    elem.srcObject = evt.stream.stream;
                    elem.play().then(function(){
                        console.log("elem play success");
                    }).catch(function (err) {
                        console.error("elem play error", err.error, err.message, err.info, err);
                        elem.setAttribute("controls", "");
                    });
                });
            });
        });
    }

</script>
<script>
    var nickname = window.localStorage && localStorage.getItem("nickname");
    function updateNickname(){
        bootbox.prompt({
            closeButton: false,
            title: "你的名字是？",
            callback: function(result){
                if (result){
                    nickname = result;
                    window.localStorage && localStorage.setItem("nickname", nickname);
                    $("#textMessage").attr("placeholder", `${nickname} 说：`);
                }else{
                    updateNickname();
                }
                elem.play();
            }
        });
    }
    function confirmNickname(){
        bootbox.confirm({
            closeButton: false,
            message: `你好，${nickname}`,
            buttons:{
                confirm: {
                    label: "是我",
                },
                cancel: {
                    label: "不是我"
                },
            },
            callback: function(result){
                if (!result){
                    updateNickname();
                }
                elem.play();
            }
        });
    }
    if(!nickname){
        updateNickname();
    }else{
        $("#textMessage").attr("placeholder", `${nickname} 说：`);
        confirmNickname();
    }

function sendTextMessage(){
    var elem = document.getElementById("textMessage")
    var text = elem.value;
    if (text){
        axios.post("/api/memobird/text", {text: `${nickname} 说：\n${text}`}).then(function(resp){
            console.log(resp);
            elem.value = "";
        });
    }
};
</script>
</body>
</html>